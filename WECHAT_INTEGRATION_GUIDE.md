# ä¼ä¸šå¾®ä¿¡ç›´æŽ¥å‘é€å›¾ç‰‡é›†æˆæŒ‡å—

## ðŸŽ¯ ç›®æ ‡

å®žçŽ°åœ¨ä¼ä¸šå¾®ä¿¡ç¾¤ä¸­ç›´æŽ¥å‘é€çŒ«å“¥å›¾æ–‡å›¾ç‰‡ï¼Œç³»ç»Ÿè‡ªåŠ¨æŽ¥æ”¶ã€åˆ†æžå¹¶åé¦ˆç»“æžœã€‚

---

## ðŸ“‹ æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1: ä¼ä¸šå¾®ä¿¡åº”ç”¨å›žè°ƒï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç›´æŽ¥åœ¨ä¼ä¸šå¾®ä¿¡å‘é€å›¾ç‰‡å³å¯
- âœ… æ— éœ€é¢å¤–æ“ä½œ
- âœ… ä½“éªŒæœ€ä½³

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜æƒé™
- âŒ éœ€è¦é…ç½®åº”ç”¨å’Œå›žè°ƒURL
- âŒ éœ€è¦å…¬ç½‘IPå’ŒåŸŸå

**é€‚ç”¨åœºæ™¯**ï¼šæœ‰ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜æƒé™ï¼Œå¸Œæœ›æœ€ä½³ä½“éªŒ

---

### æ–¹æ¡ˆ2: HTTPä¸Šä¼ æŽ¥å£ + å¿«æ·æŒ‡ä»¤ï¼ˆæŽ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… é…ç½®ç®€å•ï¼Œæ— éœ€ç®¡ç†å‘˜æƒé™
- âœ… å¯ä»¥é€šè¿‡iOSå¿«æ·æŒ‡ä»¤å®žçŽ°ä¸€é”®ä¸Šä¼ 
- âœ… çµæ´»æ€§é«˜

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦é¢å¤–æ“ä½œï¼ˆä¿å­˜å›¾ç‰‡åŽé€šè¿‡å¿«æ·æŒ‡ä»¤ä¸Šä¼ ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ— ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜æƒé™ï¼Œæˆ–å¸Œæœ›å¿«é€Ÿå®žçŽ°

---

### æ–¹æ¡ˆ3: ç›®å½•ç›‘æŽ§ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€ç®€å•ï¼Œå·²éƒ¨ç½²
- âœ… ç¨³å®šå¯é 

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦æ‰‹åŠ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨

**é€‚ç”¨åœºæ™¯**ï¼šä¸´æ—¶æ–¹æ¡ˆæˆ–æµ‹è¯•ä½¿ç”¨

---

## ðŸš€ æŽ¨èæ–¹æ¡ˆï¼šHTTPä¸Šä¼ æŽ¥å£ + iOSå¿«æ·æŒ‡ä»¤

è¿™æ˜¯æœ€å®žç”¨çš„æ–¹æ¡ˆï¼Œé…ç½®ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚

### æ­¥éª¤1: éƒ¨ç½²HTTPä¸Šä¼ æœåŠ¡

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# åˆ›å»ºsystemdæœåŠ¡
cat > /etc/systemd/system/maoge_wechat_receiver.service << 'EOF'
[Unit]
Description=Maoge WeChat Message Receiver
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/maoge_advisor
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
Environment="PYTHONPATH=/root/maoge_advisor:/root/maoge_advisor/modules"

ExecStart=/usr/bin/python3 /root/maoge_advisor/wechat_message_receiver.py --host 0.0.0.0 --port 8888

Restart=always
RestartSec=10

StandardOutput=journal
StandardError=journal
SyslogIdentifier=maoge_wechat_receiver

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
systemctl daemon-reload
systemctl enable maoge_wechat_receiver.service
systemctl start maoge_wechat_receiver.service

# æ£€æŸ¥çŠ¶æ€
systemctl status maoge_wechat_receiver.service
```

### æ­¥éª¤2: é…ç½®é˜²ç«å¢™ï¼ˆå¦‚æžœéœ€è¦ï¼‰

```bash
# å¼€æ”¾8888ç«¯å£
firewall-cmd --permanent --add-port=8888/tcp
firewall-cmd --reload

# æˆ–ä½¿ç”¨iptables
iptables -A INPUT -p tcp --dport 8888 -j ACCEPT
```

### æ­¥éª¤3: æµ‹è¯•HTTPæŽ¥å£

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://47.100.32.41:8888/health

# æµ‹è¯•ä¸Šä¼ å›¾ç‰‡
curl -X POST http://47.100.32.41:8888/upload/image \
  -F "file=@test_image.png"
```

### æ­¥éª¤4: åˆ›å»ºiOSå¿«æ·æŒ‡ä»¤

1. æ‰“å¼€iPhoneçš„"å¿«æ·æŒ‡ä»¤"App
2. åˆ›å»ºæ–°å¿«æ·æŒ‡ä»¤
3. æ·»åŠ ä»¥ä¸‹æ“ä½œï¼š

```
1. ä»Žè¾“å…¥èŽ·å–å›¾åƒ
2. è®¾ç½®å˜é‡ï¼šå›¾åƒ = å›¾åƒ
3. èŽ·å–URLå†…å®¹
   - URL: http://47.100.32.41:8888/upload/image
   - æ–¹æ³•: POST
   - è¯·æ±‚æ­£æ–‡: è¡¨å•
   - file: å›¾åƒ
4. æ˜¾ç¤ºé€šçŸ¥ï¼šä¸Šä¼ æˆåŠŸ
```

5. ä¿å­˜å¿«æ·æŒ‡ä»¤ï¼Œå‘½åä¸º"ä¸Šä¼ çŒ«å“¥å›¾æ–‡"

### æ­¥éª¤5: ä½¿ç”¨æ–¹æ³•

1. åœ¨ä¼ä¸šå¾®ä¿¡ä¿å­˜çŒ«å“¥å›¾æ–‡å›¾ç‰‡åˆ°ç›¸å†Œ
2. æ‰“å¼€"å¿«æ·æŒ‡ä»¤"App
3. è¿è¡Œ"ä¸Šä¼ çŒ«å“¥å›¾æ–‡"å¿«æ·æŒ‡ä»¤
4. é€‰æ‹©åˆšä¿å­˜çš„å›¾ç‰‡
5. ç­‰å¾…åˆ†æžç»“æžœæŽ¨é€åˆ°ä¼ä¸šå¾®ä¿¡

---

## ðŸ”§ æ–¹æ¡ˆ1è¯¦ç»†é…ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

å¦‚æžœæ‚¨æœ‰ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥é…ç½®å®Œæ•´çš„åº”ç”¨å›žè°ƒã€‚

### æ­¥éª¤1: åˆ›å»ºä¼ä¸šå¾®ä¿¡åº”ç”¨

1. ç™»å½•ä¼ä¸šå¾®ä¿¡ç®¡ç†åŽå°
2. è¿›å…¥"åº”ç”¨ç®¡ç†" â†’ "è‡ªå»ºåº”ç”¨"
3. åˆ›å»ºæ–°åº”ç”¨ï¼Œå‘½åä¸º"çŒ«å“¥å›¾æ–‡è§£è¯»"
4. è®°å½• `AgentId` å’Œ `Secret`

### æ­¥éª¤2: é…ç½®æŽ¥æ”¶æ¶ˆæ¯

1. åœ¨åº”ç”¨è¯¦æƒ…é¡µï¼Œæ‰¾åˆ°"æŽ¥æ”¶æ¶ˆæ¯"è®¾ç½®
2. è®¾ç½®URLï¼š`http://æ‚¨çš„æœåŠ¡å™¨IP:8888/wechat/callback`
3. è®¾ç½®Tokenå’ŒEncodingAESKeyï¼ˆéšæœºç”Ÿæˆï¼‰
4. ä¿å­˜é…ç½®

### æ­¥éª¤3: ä¿®æ”¹ä»£ç é…ç½®

ç¼–è¾‘ `/root/maoge_advisor/wechat_message_receiver.py`ï¼Œæ·»åŠ ï¼š

```python
# ä¼ä¸šå¾®ä¿¡é…ç½®
CORP_ID = "æ‚¨çš„ä¼ä¸šID"
AGENT_ID = "åº”ç”¨AgentId"
SECRET = "åº”ç”¨Secret"
TOKEN = "æŽ¥æ”¶æ¶ˆæ¯Token"
ENCODING_AES_KEY = "EncodingAESKey"
```

### æ­¥éª¤4: å®‰è£…ä¼ä¸šå¾®ä¿¡åŠ å¯†åº“

```bash
pip3 install pycryptodome
```

### æ­¥éª¤5: é‡å¯æœåŠ¡

```bash
systemctl restart maoge_wechat_receiver.service
```

### æ­¥éª¤6: éªŒè¯URL

åœ¨ä¼ä¸šå¾®ä¿¡ç®¡ç†åŽå°ç‚¹å‡»"ä¿å­˜"ï¼Œç³»ç»Ÿä¼šéªŒè¯URLæœ‰æ•ˆæ€§ã€‚

### æ­¥éª¤7: ä½¿ç”¨

ç›´æŽ¥åœ¨ä¼ä¸šå¾®ä¿¡åº”ç”¨ä¼šè¯ä¸­å‘é€å›¾ç‰‡å³å¯ï¼

---

## ðŸ“± iOSå¿«æ·æŒ‡ä»¤è¯¦ç»†é…ç½®

### å®Œæ•´å¿«æ·æŒ‡ä»¤é…ç½®

```
å¿«æ·æŒ‡ä»¤åç§°ï¼šä¸Šä¼ çŒ«å“¥å›¾æ–‡

æ“ä½œæµç¨‹ï¼š
1. ä»Žè¾“å…¥èŽ·å–å›¾åƒ
   - å¦‚æžœæ²¡æœ‰è¾“å…¥ï¼Œåˆ™é€‰æ‹©ç…§ç‰‡

2. è®¾ç½®å˜é‡
   - åç§°ï¼šimage
   - å€¼ï¼šå›¾åƒ

3. èŽ·å–URLå†…å®¹
   - URLï¼šhttp://47.100.32.41:8888/upload/image
   - æ–¹æ³•ï¼šPOST
   - æ ‡å¤´ï¼š
     Content-Type: multipart/form-data
   - è¯·æ±‚æ­£æ–‡ï¼šè¡¨å•
   - å­—æ®µï¼š
     file: image

4. ä»Žè¾“å…¥èŽ·å–å­—å…¸
   - è¾“å…¥ï¼šURLå†…å®¹

5. å¦‚æžœ å­—å…¸ä¸­çš„success = true
   åˆ™ï¼š
     æ˜¾ç¤ºé€šçŸ¥
     - æ ‡é¢˜ï¼šä¸Šä¼ æˆåŠŸ
     - æ­£æ–‡ï¼šå›¾ç‰‡å·²ä¸Šä¼ ï¼Œç­‰å¾…åˆ†æžç»“æžœ
   å¦åˆ™ï¼š
     æ˜¾ç¤ºé€šçŸ¥
     - æ ‡é¢˜ï¼šä¸Šä¼ å¤±è´¥
     - æ­£æ–‡ï¼šå­—å…¸ä¸­çš„error
```

### æ·»åŠ åˆ°åˆ†äº«èœå•

1. ç¼–è¾‘å¿«æ·æŒ‡ä»¤
2. æ‰“å¼€"æ˜¾ç¤ºåœ¨åˆ†äº«è¡¨å•ä¸­"
3. é€‰æ‹©"å›¾åƒ"ç±»åž‹
4. ä¿å­˜

çŽ°åœ¨å¯ä»¥åœ¨ç›¸å†Œä¸­é€‰æ‹©å›¾ç‰‡åŽï¼Œç‚¹å‡»åˆ†äº« â†’ "ä¸Šä¼ çŒ«å“¥å›¾æ–‡"

---

## ðŸ” å®‰å…¨å»ºè®®

### 1. æ·»åŠ APIå¯†é’¥è®¤è¯

ä¿®æ”¹ä»£ç ï¼Œæ·»åŠ ç®€å•çš„APIå¯†é’¥éªŒè¯ï¼š

```python
API_KEY = "your-secret-key"

@app.route('/upload/image', methods=['POST'])
def upload_image():
    # éªŒè¯APIå¯†é’¥
    api_key = request.headers.get('X-API-Key')
    if api_key != API_KEY:
        return jsonify({'success': False, 'error': 'æ— æ•ˆçš„APIå¯†é’¥'}), 401
    
    # ... åŽŸæœ‰ä»£ç 
```

åœ¨å¿«æ·æŒ‡ä»¤ä¸­æ·»åŠ æ ‡å¤´ï¼š
```
X-API-Key: your-secret-key
```

### 2. ä½¿ç”¨HTTPS

é…ç½®Nginxåå‘ä»£ç†ï¼Œæ·»åŠ SSLè¯ä¹¦ï¼š

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:8888;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. IPç™½åå•

åªå…è®¸ç‰¹å®šIPè®¿é—®ï¼š

```python
ALLOWED_IPS = ['your-ip-address']

@app.before_request
def check_ip():
    if request.remote_addr not in ALLOWED_IPS:
        return jsonify({'error': 'Forbidden'}), 403
```

---

## ðŸ“Š ä½¿ç”¨æµç¨‹

### å®Œæ•´æµç¨‹

```
1. çŒ«å“¥å‘å¸ƒå›¾æ–‡
   â†“
2. åœ¨ä¼ä¸šå¾®ä¿¡ä¿å­˜å›¾ç‰‡
   â†“
3. è¿è¡ŒiOSå¿«æ·æŒ‡ä»¤ä¸Šä¼ 
   â†“
4. æœåŠ¡å™¨æŽ¥æ”¶å¹¶ä¿å­˜å›¾ç‰‡
   â†“
5. OCRæå–æ–‡å­—
   â†“
6. è¯­ä¹‰åˆ†æž
   â†“
7. ä¿¡å·è¯†åˆ«å’Œç¬‘è„¸é¢„æµ‹
   â†“
8. æŽ¨é€åˆ†æžç»“æžœåˆ°ä¼ä¸šå¾®ä¿¡
   â†“
9. çŒ«å“¥å‘å¸ƒå®žé™…ç¬‘è„¸
   â†“
10. åé¦ˆå®žé™…ç»“æžœ
   â†“
11. ç³»ç»Ÿå­¦ä¹ ä¼˜åŒ–
```

---

## ðŸ§ª æµ‹è¯•

### æµ‹è¯•HTTPæŽ¥å£

```bash
# 1. å¥åº·æ£€æŸ¥
curl http://47.100.32.41:8888/health

# 2. ä¸Šä¼ å›¾ç‰‡
curl -X POST http://47.100.32.41:8888/upload/image \
  -F "file=@test.png"

# 3. åé¦ˆç¬‘è„¸
curl -X POST http://47.100.32.41:8888/feedback \
  -H "Content-Type: application/json" \
  -d '{"prediction_id": 1, "actual_smile": "buy_smile", "actual_count": 2}'
```

### æµ‹è¯•å¿«æ·æŒ‡ä»¤

1. å‡†å¤‡ä¸€å¼ æµ‹è¯•å›¾ç‰‡
2. è¿è¡Œå¿«æ·æŒ‡ä»¤
3. æ£€æŸ¥ä¼ä¸šå¾®ä¿¡æ˜¯å¦æ”¶åˆ°åˆ†æžç»“æžœ

---

## â“ æ•…éšœæŽ’æŸ¥

### é—®é¢˜1: ä¸Šä¼ å¤±è´¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status maoge_wechat_receiver.service

# æŸ¥çœ‹æ—¥å¿—
journalctl -u maoge_wechat_receiver.service -f

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 8888
```

### é—®é¢˜2: ä¼ä¸šå¾®ä¿¡æœªæ”¶åˆ°æŽ¨é€

```bash
# æµ‹è¯•Webhook
curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=..." \
  -H "Content-Type: application/json" \
  -d '{"msgtype":"text","text":{"content":"æµ‹è¯•"}}'
```

### é—®é¢˜3: å¿«æ·æŒ‡ä»¤æŠ¥é”™

- æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
- æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™

---

## ðŸ“ æ€»ç»“

**æŽ¨èé…ç½®**ï¼šHTTPä¸Šä¼ æŽ¥å£ + iOSå¿«æ·æŒ‡ä»¤

**ä¼˜åŠ¿**ï¼š
- âœ… é…ç½®ç®€å•ï¼ˆ5åˆ†é’Ÿå®Œæˆï¼‰
- âœ… æ— éœ€ç®¡ç†å‘˜æƒé™
- âœ… ä½¿ç”¨æ–¹ä¾¿ï¼ˆ2æ­¥å®Œæˆä¸Šä¼ ï¼‰
- âœ… ç¨³å®šå¯é 

**ä½¿ç”¨ä½“éªŒ**ï¼š
1. ä¼ä¸šå¾®ä¿¡ä¿å­˜å›¾ç‰‡ï¼ˆ1ç§’ï¼‰
2. è¿è¡Œå¿«æ·æŒ‡ä»¤ï¼ˆ1ç§’ï¼‰
3. ç­‰å¾…åˆ†æžç»“æžœï¼ˆ5ç§’ï¼‰

**æ€»è€—æ—¶**ï¼šçº¦7ç§’å®Œæˆæ•´ä¸ªæµç¨‹ï¼

---

**ç‰ˆæœ¬**: v1.0.0  
**æ›´æ–°æ—¶é—´**: 2026-02-17
